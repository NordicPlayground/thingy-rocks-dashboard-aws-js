class Globe{constructor(e){this.sidebar=new Sidebar,this.viewer=this.initViewer(),this.configScene(this.viewer),this.getDevices(),this.clickAction(this.viewer,this.sidebar)}configScene(e){return e.scene.screenSpaceCameraController.enableTilt=!1,document.querySelector("#zoom-out").addEventListener("click",function(){var t=e.scene.globe.ellipsoid.cartesianToCartographic(e.camera.position).height,i=t<3e5?t/15:t/5;e.camera.moveBackward(i)}),document.querySelector("#zoom-in").addEventListener("click",function(){var t=e.scene.globe.ellipsoid.cartesianToCartographic(e.camera.position).height,i=t<3e5?t/15:t/5;e.camera.moveForward(i)}),e}initViewer(){var e=Cesium.createDefaultImageryProviderViewModels(),t=new Cesium.Viewer("cesiumContainer",{imageryProviderViewModels:e,selectedImageryProviderViewModel:e[1]});return t.scene.postRender.addEventListener(function(e){1==t.scene.globe.tilesLoaded&&document.querySelector(".intro-container")&&!document.querySelector(".intro-container").classList.contains("globe-rendered")&&(document.querySelector(".intro-container").classList.add("globe-rendered"),document.querySelector(".message").innerHTML="Click Anywhere to Begin.")}),t}getDevices(){document.querySelector(".device-list"),this.viewer,this.sidebar;var e=this,t=getAjaxSettings("https://api.nrfcloud.com/v1/devices?includeState=true&includeStateMeta=true&pageSort=desc");$.ajax(t).done(function(t){var i=t.items,a=[];for(let e=0;e<i.length;e++)a[i[e].id]=new Device(i[e]);e.addPoints(a)})}addPoints(e){var t=document.querySelector(".device-list"),i=this.viewer,a=this.sidebar;if(Object.keys(e).length>1)for(const r in e)this.addPoint(i,e[r],t,a)}addPoint(e,t,i,a){let r=void 0!=t.position,o=1==r?Cesium.Cartesian3.fromDegrees(t.position[1],t.position[0]):null,d=this.createListEntry(t,i),s=e.entities.add({position:o,properties:{id:t.id,name:t.properties.name,...t.gps&&t.gps.readable?{coords:t.gps.readable}:{},list_entry:d,data:t.properties.data},billboard:{height:32,width:32,image:"assets/img/nordic-icon-g.svg",show:r}});d.addEventListener("click",function(){e.selectedEntity=s,window.innerWidth<771&&a.closeSidebar()})}createListEntry(e,t){let i=document.createElement("li");return i.innerHTML='<a href="#" class="'+e.properties.connected+'">'+e.properties.name+"</a>",t.appendChild(i),i}clickAction(e,t){e.selectedEntityChanged.addEventListener(function(){if(document.querySelector(".infobox")&&document.querySelector(".infobox").remove(),Globe.resetIcons(e),void 0!==e.selectedEntity){Globe.getMessagesForDevice(e.selectedEntity._properties._id._value),Globe.populateSidebar(e.selectedEntity),Globe.populateMobileData(e.selectedEntity),e.selectedEntity.billboard={height:64,width:64,image:"assets/img/nordic-icon-y.svg"};var i=e.selectedEntity._properties._list_entry._value;void 0!==i&&(null!==document.querySelector(".device-list li.active")&&document.querySelector(".device-list li.active").classList.remove("active"),i.classList.add("active")),e.selectedEntity._properties._coords&&e.flyTo(e.selectedEntity,{offset:new Cesium.HeadingPitchRange(0,-90,5e3)}),window.innerWidth>770?t.openSidebar():document.querySelector(".mobile-sidebar").classList.add("reveal")}else t.closeSidebar(),t.closeMobileSidebar()})}static getMessagesForDevice(e){var t=getAjaxSettings("https://api.nrfcloud.com/v1/messages?inclusiveStart=2018-06-18T19%3A19%3A45.902Z&exclusiveEnd=3000-06-20T19%3A19%3A45.902Z&deviceIdentifiers="+e+"&pageLimit=1&pageSort=desc&appId=TEMP"),i=getAjaxSettings("https://api.nrfcloud.com/v1/messages?inclusiveStart=2018-06-18T19%3A19%3A45.902Z&exclusiveEnd=3000-06-20T19%3A19%3A45.902Z&deviceIdentifiers="+e+"&pageLimit=1&pageSort=desc&appId=HUMID");$(".device-data__datum.temp .datum-info").html("Loading..."),$(".device-data__datum.humidity .datum-info").html("Loading..."),$(".device-data__datum").show(),$.when($.ajax(t),$.ajax(i)).done(function(e,t){var i={Temperature:{data:null,timestamp:null},Humidity:{data:null,timestamp:null}},a=e[0].items&&e[0].items[0],r=t[0].items&&t[0].items[0];a&&(i.Temperature.data=a.message.data,i.Temperature.timestamp=moment(new Date(Date.parse(a.receivedAt))).format("ddd MMM DD YYYY, kk:mm:ss")),r&&(i.Humidity.data=r.message.data,i.Humidity.timestamp=moment(new Date(Date.parse(r.receivedAt))).format("ddd MMM DD YYYY, kk:mm:ss")),$(".device-data__datum.temp .datum-info").html(Globe.formatDataString(i,"Temperature")),$(".device-data__datum.temp .datum-timestamp").html(Globe.formatTimestamp(i,"Temperature")),$(".device-data__datum.humidity .datum-info").html(Globe.formatDataString(i,"Humidity")),$(".device-data__datum.humidity .datum-timestamp").html(Globe.formatTimestamp(i,"Humidity"))})}static formatDataString(e,t){return e[t].data?`${e[t].data}${Device.dataMap[t].unit}`:"--"}static formatTimestamp(e,t){return e[t].timestamp?`updated ${e[t].timestamp}`:"No update"}static populateSidebar(e){var t=e._properties,i=document.querySelector(".data-display"),a=i.querySelector(".device-location-name-label"),r=i.querySelector(".coordinates");a.innerHTML=t._name,r.innerHTML=t._coords&&t._coords._value?t._coords:"No GPS Data Available"}static populateMobileData(e){var t=e._properties,i=document.querySelector(".mobile-sidebar .data-display"),a=i.querySelector(".device-location-name-label"),r=i.querySelector(".coordinates");i.querySelector(".mobile-sidebar .device-data");a.innerHTML=t._name,r.innerHTML=t._coords&&t._coords._value?t._coords:"No GPS Data Available"}static resetIcons(e){var t=e.entities._entities._array;if(void 0!==e.selectedEntity)for(let e=0;e<t.length;e++)void 0!==t[e]._billboard._image&&(t[e].billboard={height:32,width:32,image:"assets/img/nordic-icon-g.svg"})}}